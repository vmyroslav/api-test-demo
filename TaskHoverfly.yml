version: 3

# Hoverfly Management
env:
  COMPOSE_SERVICE_NAME: hoverfly
  SIMULATION_PATH: ./testdata/hoverfly/
#  HOVERFLY_PROXY: localhost:8500

vars:
  COMPOSE_SERVICE_NAME: hoverfly

tasks:
  build:
    desc: Build Hoverfly container
    cmds:
      - docker compose build {{.COMPOSE_SERVICE_NAME}}

  start:
    desc: Start Hoverfly container
    cmds:
      - docker compose up -d --wait {{.COMPOSE_SERVICE_NAME}}

  stop:
    desc: Stop Hoverfly
    cmds:
      - docker compose stop {{.COMPOSE_SERVICE_NAME}}

  export:
    desc: Export current simulation
    cmds:
      - docker compose exec {{.COMPOSE_SERVICE_NAME}} hoverctl export {{.SIMULATION_DIR}}/{{.SIMULATION_FILE}}.json
    requires:
      vars:
        - SIMULATION_DIR
        - SIMULATION_FILE

  import:
    desc: Import provided simulation
    cmds:
      - docker compose exec {{.COMPOSE_SERVICE_NAME}} hoverctl import {{.SIMULATION_FILE}}
    requires:
      vars:
        - SIMULATION_FILE

  import-last:
    desc: Import last simulation
    cmds:
      - docker compose exec {{.COMPOSE_SERVICE_NAME}} hoverctl import $(ls -t ${SIMULATION_PATH} | head -n 1)
    internal: true

  mode:
    desc: Set Hoverfly mode (capture/simulate/spy/modify)
    vars:
      name: MODE
      enum: [capture, simulate, spy, modify]
    cmds:
      - docker compose exec {{.COMPOSE_SERVICE_NAME}} hoverctl mode {{.MODE}}

  logs:
    desc: Show Hoverfly logs
    cmds:
      - docker compose logs {{.COMPOSE_SERVICE_NAME}}

  process-simulation:
    desc: Process captured simulation to handle random data
    cmds:
      - go run ./tools/processor/*.go -file {{.SIMULATION_FILE}}
    requires:
      vars:
        - SIMULATION_FILE